<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BagTrace Dashboard</title>

</head>
<body>

    <h1>‚úàÔ∏è BagTrace Live Monitor</h1>

    <div class="plane-container">
        <h3 style="width: 100%; margin-top: 0;">Letadla ve vzduchu (Nalo≈æeno)</h3>
        <div id="plane-list"></div>
    </div>
    
    <div class="belts-wrapper">
        <div id="belt-1" class="belt">
            <h2>P√°s ƒç. 1 (EU / Czech)</h2>
            <div id="list-1"></div>
        </div>
        <div id="belt-2" class="belt">
            <h2>P√°s ƒç. 2 (International)</h2>
            <div id="list-2"></div>
        </div>
    </div>

    <script>
        const ws = new WebSocket(`ws://${location.host}`);

        // NASTAVEN√ç ƒåASOVAƒåE (Pro demo dej 20 sekund = 20000)
        const TIMEOUT_MS = 20000; 

        ws.onopen = () => console.log("‚úÖ P≈ôipojeno k Beta Serveru");

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            console.log("Nov√° zpr√°va:", msg);
            
            if (msg.type === 'PLANE_LOADED') {
                createBagInPlane(msg.bag);
            } else if (msg.type === 'BELT_ARRIVAL') {
                moveBagToBelt(msg.bag, msg.belt);
            }
        };

        // --- FUNKCE PRO UI ---

        // 1. Vytvo≈ô√≠ kufr v horn√≠m modr√©m boxu
        function createBagInPlane(bag) {
            // Zamezen√≠ duplicit√°m
            if (document.getElementById(`bag-${bag.id}`)) return;

            const el = document.createElement('div');
            el.id = `bag-${bag.id}`;
            el.className = 'bag in-plane';
            el.innerHTML = `‚úàÔ∏è ${bag.flight}<br><small>${bag.owner}</small>`;
            document.getElementById('plane-list').appendChild(el);
        }

        // 2. P≈ôesune kufr na p√°s a spust√≠ odpoƒçet
        function moveBagToBelt(bag, beltNum) {
            let el = document.getElementById(`bag-${bag.id}`);
            
            // Pokud kufr nebyl v letadle (nap≈ô. po refresh str√°nky), vytvo≈ô√≠me nov√Ω
            if (!el) {
                el = document.createElement('div');
                el.id = `bag-${bag.id}`;
            }

            // Nastaven√≠ vzhledu pro p√°s
            el.className = 'bag'; // Reset t≈ô√≠d
            el.innerHTML = `
                üß≥ <b>${bag.owner}</b><br>
                <small>Let: ${bag.flight}</small>
                <span class="timer">ƒåek√° na vyzvednut√≠...</span>
                <button onclick="pickupBag('${bag.id}')">Vyzvednout</button>
            `;

            // P≈ôid√°n√≠ do spr√°vn√©ho p√°su (na zaƒç√°tek seznamu)
            const beltList = document.getElementById(`list-${beltNum}`);
            beltList.prepend(el);

            // Spu≈°tƒõn√≠ ƒçasovaƒçe
            const timerId = setTimeout(() => {
                // ƒåas vypr≈°el -> ƒåerven√°
                el.classList.add('missed');
                el.querySelector('.timer').innerText = "‚ö†Ô∏è NEVYZVEDNUTO (Time out)";
                const btn = el.querySelector('button');
                if(btn) btn.remove();
            }, TIMEOUT_MS);

            // Ulo≈æ√≠me ID timeru do elementu, abychom ho mohli zru≈°it p≈ôi kliknut√≠
            el.dataset.timerId = timerId;
        }

        // 3. Funkce tlaƒç√≠tka "Vyzvednout"
        window.pickupBag = (id) => {
            const el = document.getElementById(`bag-${id}`);
            if (!el) return;

            // Zastavit odpoƒçet
            clearTimeout(el.dataset.timerId);

            // Zmƒõnit na Zelenou
            el.classList.add('ok');
            el.querySelector('.timer').innerText = "‚úÖ Vyzvednuto";
            el.querySelector('button').remove(); // Odstranit tlaƒç√≠tko

            // (Voliteln√©) Odeslat info zpƒõt na server
            fetch('/bag/collected', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bagId: id })
            }).catch(err => console.log("Chyba p≈ôi odes√≠l√°n√≠ potvrzen√≠"));
        };
    </script>
</body>
</html>